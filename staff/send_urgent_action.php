<?php
session_start();
include '../config.php'; // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Path р╣Гр╕лр╣Йр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З

// р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Гр╕лр╣Й Response р╕Бр╕ер╕▒р╕Ър╣Др╕Ыр╣Ар╕Ыр╣Зр╕Щ JSON р╣Ар╕кр╕бр╕н р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Й Fetch р╣Гр╕Щ JS р╕Чр╕│р╕Зр╕▓р╕Щр╣Др╕Фр╣Йр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
header('Content-Type: application/json');

/**
 * 1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣М (Security First)
 */
if (!isset($_SESSION['role']) || ($_SESSION['role'] !== 'staff' && $_SESSION['role'] !== 'admin')) {
    echo json_encode([
        'success' => false, 
        'message' => 'Unauthorized: р╕Др╕╕р╕Ур╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕кр╣Ир╕Зр╕Бр╕▓р╕гр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Щр╕╡р╣Й'
    ]);
    exit();
}

/**
 * 2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ Method р╣Бр╕ер╕░р╕Др╣Ир╕▓р╕Чр╕╡р╣Ир╕кр╣Ир╕Зр╕бр╕▓
 */
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['menu_name'])) {
    
    // р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щ SQL Injection р╣Бр╕ер╕░р╕Хр╕▒р╕Фр╕Кр╣Ир╕нр╕Зр╕зр╣Ир╕▓р╕З
    $menu_name = mysqli_real_escape_string($conn, trim($_POST['menu_name']));
    
    // р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ьр╕╣р╣Йр╕кр╣Ир╕Зр╣Бр╕ер╕░р╣Ар╕зр╕ер╕▓
    $sender = $_SESSION['username'] ?? 'р╕Юр╕Щр╕▒р╕Бр╕Зр╕▓р╕Щ';
    $time_now = date('H:i'); 

    // 3. р╕Ыр╕гр╕▒р╕Ър╣Бр╕Хр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Гр╕лр╣Й "р╣Ар╕Фр╣Ир╕Щ" р╕кр╕│р╕лр╕гр╕▒р╕Ъ Admin
    // р╣Гр╕кр╣Ир╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕лр╕бр╕▓р╕в [ ] р╣Бр╕ер╕░р╕гр╕░р╕Ър╕╕р╣Ар╕зр╕ер╕▓р╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Й Admin р╣Бр╕вр╕Бр╣Бр╕вр╕░р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Фр╣Йр╕Зр╣Ир╕▓р╕в
    $message = "ЁЯЪи р╣Бр╕Ир╣Йр╕Зр╕Фр╣Ир╕зр╕Щ: р╣Ар╕бр╕Щр╕╣ [ $menu_name ] р╕лр╕бр╕Фр╕кр╕Хр╣Зр╕нр╕Б! (р╕кр╣Ир╕Зр╣Вр╕Фр╕в: $sender р╣Ар╕бр╕╖р╣Ир╕н $time_now р╕Щ.)";

    // 4. р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕ер╕Зр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
    // р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕: р╕Хр╣Йр╕нр╕Зр╕бр╕▒р╣Ир╕Щр╣Гр╕Ир╕зр╣Ир╕▓р╕гр╕▒р╕Щр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕кр╕гр╣Йр╕▓р╕Зр╕Хр╕▓р╕гр╕▓р╕З tb_notifications р╣Бр╕ер╣Йр╕з
    $sql = "INSERT INTO tb_notifications (message, type, status) 
            VALUES ('$message', 'urgent', 'unread')";

    if (mysqli_query($conn, $sql)) {
        echo json_encode([
            'success' => true,
            'message' => 'р╕кр╣Ир╕Зр╕кр╕▒р╕Нр╕Нр╕▓р╕Ур╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕кр╕│р╣Ар╕гр╣Зр╕И'
        ]);
    } else {
        echo json_encode([
            'success' => false, 
            'message' => 'Database Error: ' . mysqli_error($conn)
        ]);
    }

} else {
    echo json_encode([
        'success' => false, 
        'message' => 'Invalid Request: р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ'
    ]);
}
?>